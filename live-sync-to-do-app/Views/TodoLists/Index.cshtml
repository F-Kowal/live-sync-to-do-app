@model IEnumerable<live_sync_to_do_app.Models.TodoList>

@{
    ViewData["Title"] = "My Todo Lists";
    Layout = "_Layout";
}

@* Hidden form for anti-forgery token *@
<form id="antiForgeryForm" style="display: none;">
    @Html.AntiForgeryToken()
</form>

<div class="todo-app-container">
    <div class="todo-sidebar">
        <div class="todo-sidebar-header">
            <h3>My Lists</h3>
            <button class="btn btn-create-list" data-bs-toggle="modal" data-bs-target="#createListModal">
                <i class="bi bi-plus-lg"></i> New List
            </button>
        </div>
        
        <div id="listsContainer">
            @if (Model != null && Model.Any())
            {
                @foreach (var list in Model)
                {
                    <div class="todo-list-item @(list == Model.First() ? "active" : "")" 
                         data-list-id="@list.Id"
                         data-list-name="@list.Name"
                         data-list-shared="@(list.SharedWith ?? "")"
                         onclick="loadList(@list.Id)">
                        <div class="todo-list-item-name">@list.Name</div>
                        <div class="todo-list-item-meta">
                            <span>@(list.Tasks?.Count ?? 0) tasks</span>
                            @if (list.OwnerEmail != User.Identity.Name)
                            {
                                <span class="badge bg-info">Shared</span>
                            }
                        </div>
                        <div class="todo-list-item-actions" onclick="event.stopPropagation()">
                            @if (list.OwnerEmail == User.Identity.Name)
                            {
                                <button class="btn btn-sm btn-outline-primary" onclick="editListFromElement(this)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteList(@list.Id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-state-icon">📝</div>
                    <h3>No lists yet</h3>
                    <p>Create your first todo list to get started!</p>
                </div>
            }
        </div>
    </div>

    <div class="todo-main-area">
        <div id="listContent">
            @if (Model != null && Model.Any())
            {
                var firstList = Model.First();
                <div class="todo-main-header">
                    <h2>@firstList.Name</h2>
                    <div class="list-meta">
                        @if (firstList.OwnerEmail == User.Identity.Name)
                        {
                            <span>Owner</span>
                        }
                        else
                        {
                            <span>Shared by @firstList.OwnerEmail</span>
                        }
                    </div>
                </div>

                <div class="add-task-section">
                    <div class="add-task-input-group">
                        <input type="text" id="taskInput" class="form-control" placeholder="Add a new task..." onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); addTask(); }">
                        <button class="btn btn-add-task" onclick="addTask()">Add Task</button>
                    </div>
                    <div class="task-options-toggle" onclick="toggleTaskOptions()">
                        <i class="bi bi-chevron-down" id="optionsIcon"></i> 
                        <span>Add description or due date (optional)</span>
                    </div>
                    <div class="task-options" id="taskOptions" style="display: none;">
                        <div class="form-group-modern">
                            <label for="taskDescription" class="form-label-modern">Description</label>
                            <textarea id="taskDescription" class="form-control-modern" rows="3" placeholder="Add a description..."></textarea>
                        </div>
                        <div class="form-group-modern">
                            <label for="taskDueDate" class="form-label-modern">Due Date</label>
                            <input type="date" id="taskDueDate" class="form-control-modern">
                        </div>
                    </div>
                </div>

                @if (firstList.OwnerEmail == User.Identity.Name)
                {
                    <div class="share-section">
                        <h5>Share this list</h5>
                        <div class="share-input-group">
                            <input type="email" id="shareEmailInput" class="form-control" placeholder="Enter email address...">
                            <button class="btn btn-share" onclick="shareList(@firstList.Id)">Share</button>
                        </div>
                        @if (!string.IsNullOrEmpty(firstList.SharedWith))
                        {
                            <div class="shared-users">
                                <strong>Shared with:</strong>
                                @foreach (var email in firstList.SharedWith.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                {
                                    <span class="shared-user-badge">@email</span>
                                }
                            </div>
                        }
                    </div>
                }

                <div class="tasks-container" id="tasksContainer">
                    @if (firstList.Tasks != null && firstList.Tasks.Any())
                    {
                        @foreach (var task in firstList.Tasks)
                        {
                            <div class="task-card @(task.IsCompleted ? "completed" : "")" id="task-@task.Id">
                                <div class="task-content">
                                    <input type="checkbox" class="task-checkbox" 
                                           @(task.IsCompleted ? "checked" : "") 
                                           onchange="toggleTask(@task.Id)">
                                    <div class="task-main-info">
                                        <p class="task-title">@task.Title</p>
                                        @if (!string.IsNullOrEmpty(task.Description))
                                        {
                                            <p class="task-description">@task.Description</p>
                                        }
                                        @if (task.DueDate.HasValue)
                                        {
                                            <div class="task-due-date">
                                                <i class="bi bi-calendar"></i>
                                                <span>Due: @task.DueDate.Value.ToString("MMM dd, yyyy")</span>
                                                @if (task.DueDate.Value < DateTime.Now && !task.IsCompleted)
                                                {
                                                    <span class="badge bg-danger">Overdue</span>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="task-actions">
                                    <button class="btn btn-delete-task" onclick="deleteTask(@task.Id)">×</button>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="empty-state">
                            <div class="empty-state-icon">✓</div>
                            <h3>No tasks yet</h3>
                            <p>Add your first task above to get started!</p>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="no-list-selected">
                    <div class="no-list-selected-content">
                        <h3>Welcome to Todo App!</h3>
                        <p>Create your first list to get started.</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="createListModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New List</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createListForm">
                    <div class="mb-3">
                        <label for="listNameInput" class="form-label">List Name</label>
                        <input type="text" class="form-control" id="listNameInput" required>
                    </div>
                    <div class="mb-3">
                        <label for="sharedWithInput" class="form-label">Share with (optional, comma-separated emails)</label>
                        <input type="text" class="form-control" id="sharedWithInput" placeholder="email1@example.com, email2@example.com">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createList()">Create</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editListModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit List</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editListForm">
                    <input type="hidden" id="editListId">
                    <div class="mb-3">
                        <label for="editListNameInput" class="form-label">List Name</label>
                        <input type="text" class="form-control" id="editListNameInput" required>
                    </div>
                    <div class="mb-3">
                        <label for="editSharedWithInput" class="form-label">Share with (comma-separated emails)</label>
                        <input type="text" class="form-control" id="editSharedWithInput" placeholder="email1@example.com, email2@example.com">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveList()">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        let currentListId = @(Model != null && Model.Any() ? Model.First().Id : 0);
        let currentUserEmail = '@User.Identity.Name';
        let connection = null;

        document.addEventListener('DOMContentLoaded', function() {
            if (currentListId > 0) {
                initializeSignalR();
            }
        });

        function initializeSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/todoHub")
                .build();

            connection.start().then(() => {
                connection.invoke("JoinUserGroup", currentUserEmail);
                
                if (currentListId > 0) {
                    connection.invoke("JoinListGroup", currentListId);
                }
            }).catch(err => console.error(err.toString()));

            connection.on("ReceiveTaskAdded", (taskId, title, description, dueDate) => {
                if (currentListId > 0) {
                    const existingTask = document.getElementById(`task-${taskId}`);
                    if (!existingTask) {
                        addTaskToUI(taskId, title, description, dueDate, false);
                    }
                }
            });

            connection.on("ReceiveTaskToggled", (taskId, isCompleted) => {
                updateTaskUI(taskId, isCompleted);
            });

            connection.on("ReceiveTaskDeleted", (taskId) => {
                removeTaskFromUI(taskId);
            });

            connection.on("ReceiveListUpdated", (listId) => {
                if (listId === currentListId) {
                    loadList(listId);
                }
            });

            connection.on("ReceiveListShared", (listId, listName, ownerEmail) => {
                addListToSidebar(listId, listName, ownerEmail, true);
            });
        }

        async function loadList(listId) {
            if (connection && currentListId > 0) {
                await connection.invoke("LeaveListGroup", currentListId);
            }

            currentListId = listId;

            document.querySelectorAll('.todo-list-item').forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.dataset.listId) === listId) {
                    item.classList.add('active');
                }
            });

            try {
                const response = await fetch(`/TodoLists/GetList?id=${listId}`);
                if (!response.ok) {
                    throw new Error('Failed to load list');
                }
                const list = await response.json();

                const isOwner = list.ownerEmail === currentUserEmail;
                document.getElementById('listContent').innerHTML = `
                    <div class="todo-main-header">
                        <h2>${escapeHtml(list.name)}</h2>
                        <div class="list-meta">
                            ${isOwner ? '<span>Owner</span>' : `<span>Shared by ${escapeHtml(list.ownerEmail)}</span>`}
                        </div>
                    </div>

                    <div class="add-task-section">
                        <div class="add-task-input-group">
                            <input type="text" id="taskInput" class="form-control" placeholder="Add a new task..." onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); addTask(); }">
                            <button class="btn btn-add-task" onclick="addTask()">Add Task</button>
                        </div>
                        <div class="task-options-toggle" onclick="toggleTaskOptions()">
                            <i class="bi bi-chevron-down" id="optionsIcon"></i> 
                            <span>Add description or due date (optional)</span>
                        </div>
                        <div class="task-options" id="taskOptions" style="display: none;">
                            <div class="form-group-modern">
                                <label for="taskDescription" class="form-label-modern">Description</label>
                                <textarea id="taskDescription" class="form-control-modern" rows="3" placeholder="Add a description..."></textarea>
                            </div>
                            <div class="form-group-modern">
                                <label for="taskDueDate" class="form-label-modern">Due Date</label>
                                <input type="date" id="taskDueDate" class="form-control-modern">
                            </div>
                        </div>
                    </div>

                    ${isOwner ? `
                    <div class="share-section">
                        <h5>Share this list</h5>
                        <div class="share-input-group">
                            <input type="email" id="shareEmailInput" class="form-control" placeholder="Enter email address...">
                            <button class="btn btn-share" onclick="shareList(${list.id})">Share</button>
                        </div>
                        ${list.sharedWith ? `
                        <div class="shared-users">
                            <strong>Shared with:</strong>
                            ${list.sharedWith.split(',').map(email => `<span class="shared-user-badge">${escapeHtml(email.trim())}</span>`).join('')}
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}

                    <div class="tasks-container" id="tasksContainer">
                        ${list.tasks && list.tasks.length > 0 ? 
                            list.tasks.map(task => {
                                const descriptionHtml = task.description ? `<p class="task-description">${escapeHtml(task.description)}</p>` : '';
                                let dueDateHtml = '';
                                if (task.dueDate) {
                                    const dueDateObj = new Date(task.dueDate);
                                    const now = new Date();
                                    const isOverdue = dueDateObj < now && !task.isCompleted;
                                    const formattedDate = dueDateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                                    dueDateHtml = `
                                        <div class="task-due-date">
                                            <i class="bi bi-calendar"></i>
                                            <span>Due: ${formattedDate}</span>
                                            ${isOverdue ? '<span class="badge bg-danger">Overdue</span>' : ''}
                                        </div>
                                    `;
                                }
                                return `
                                <div class="task-card ${task.isCompleted ? 'completed' : ''}" id="task-${task.id}">
                                    <div class="task-content">
                                        <input type="checkbox" class="task-checkbox" 
                                               ${task.isCompleted ? 'checked' : ''} 
                                               onchange="toggleTask(${task.id})">
                                        <div class="task-main-info">
                                            <p class="task-title">${escapeHtml(task.title)}</p>
                                            ${descriptionHtml}
                                            ${dueDateHtml}
                                        </div>
                                    </div>
                                    <div class="task-actions">
                                        <button class="btn btn-delete-task" onclick="deleteTask(${task.id})">×</button>
                                    </div>
                                </div>
                            `;
                            }).join('') : 
                            `<div class="empty-state">
                                <div class="empty-state-icon">✓</div>
                                <h3>No tasks yet</h3>
                                <p>Add your first task above to get started!</p>
                            </div>`
                        }
                    </div>
                `;

                if (connection) {
                    await connection.invoke("JoinListGroup", listId);
                } else {
                    initializeSignalR();
                }
            } catch (error) {
                console.error('Error loading list:', error);
                alert('Failed to load list. Please try again.');
            }
        }

        async function addTask() {
            const input = document.getElementById('taskInput');
            const descriptionInput = document.getElementById('taskDescription');
            const dueDateInput = document.getElementById('taskDueDate');
            const title = input.value.trim();
            if (!title || currentListId === 0) return;

            try {
                const description = descriptionInput ? descriptionInput.value.trim() : '';
                const dueDate = dueDateInput && dueDateInput.value ? dueDateInput.value : null;

                const token = getAntiForgeryToken();
                const headers = token ? { 'RequestVerificationToken': token } : {};
                
                let url = `/TodoLists/AddTask?listId=${currentListId}&title=${encodeURIComponent(title)}`;
                if (description) {
                    url += `&description=${encodeURIComponent(description)}`;
                }
                if (dueDate) {
                    url += `&dueDate=${encodeURIComponent(dueDate)}`;
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers
                });

                if (!response.ok) throw new Error('Failed to add task');

                const data = await response.json();
                addTaskToUI(data.id, data.title, data.description, data.dueDate, false);
                
                if (connection) {
                    await connection.invoke("SendTaskAdded", currentListId, data.id, data.title, data.description || "", data.dueDate || "");
                }

                input.value = '';
                if (descriptionInput) descriptionInput.value = '';
                if (dueDateInput) dueDateInput.value = '';
                const optionsDiv = document.getElementById('taskOptions');
                if (optionsDiv && optionsDiv.style.display !== 'none') {
                    toggleTaskOptions();
                }
            } catch (error) {
                console.error('Error adding task:', error);
                alert('Failed to add task. Please try again.');
            }
        }

        function toggleTaskOptions() {
            const optionsDiv = document.getElementById('taskOptions');
            const icon = document.getElementById('optionsIcon');
            if (optionsDiv && icon) {
                if (optionsDiv.style.display === 'none') {
                    optionsDiv.style.display = 'block';
                    icon.classList.remove('bi-chevron-down');
                    icon.classList.add('bi-chevron-up');
                } else {
                    optionsDiv.style.display = 'none';
                    icon.classList.remove('bi-chevron-up');
                    icon.classList.add('bi-chevron-down');
                }
            }
        }

        function addTaskToUI(taskId, title, description, dueDate, isCompleted) {
            const container = document.getElementById('tasksContainer');
            
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const taskCard = document.createElement('div');
            taskCard.className = `task-card ${isCompleted ? 'completed' : ''}`;
            taskCard.id = `task-${taskId}`;
            
            let descriptionHtml = '';
            if (description) {
                descriptionHtml = `<p class="task-description">${escapeHtml(description)}</p>`;
            }
            
            let dueDateHtml = '';
            if (dueDate) {
                const dueDateObj = new Date(dueDate);
                const now = new Date();
                const isOverdue = dueDateObj < now && !isCompleted;
                const formattedDate = dueDateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                dueDateHtml = `
                    <div class="task-due-date">
                        <i class="bi bi-calendar"></i>
                        <span>Due: ${formattedDate}</span>
                        ${isOverdue ? '<span class="badge bg-danger">Overdue</span>' : ''}
                    </div>
                `;
            }
            
            taskCard.innerHTML = `
                <div class="task-content">
                    <input type="checkbox" class="task-checkbox" 
                           ${isCompleted ? 'checked' : ''} 
                           onchange="toggleTask(${taskId})">
                    <div class="task-main-info">
                        <p class="task-title">${escapeHtml(title)}</p>
                        ${descriptionHtml}
                        ${dueDateHtml}
                    </div>
                </div>
                <div class="task-actions">
                    <button class="btn btn-delete-task" onclick="deleteTask(${taskId})">×</button>
                </div>
            `;
            container.appendChild(taskCard);
        }

        async function toggleTask(taskId) {
            try {
                const token = getAntiForgeryToken();
                const headers = token ? { 'RequestVerificationToken': token } : {};
                
                const response = await fetch(`/TodoLists/ToggleTask?taskId=${taskId}`, {
                    method: 'POST',
                    headers: headers
                });

                if (!response.ok) throw new Error('Failed to toggle task');

                const data = await response.json();
                updateTaskUI(taskId, data.isCompleted);

                if (connection) {
                    await connection.invoke("SendTaskToggled", currentListId, taskId, data.isCompleted);
                }
            } catch (error) {
                console.error('Error toggling task:', error);
                alert('Failed to update task. Please try again.');
            }
        }

        function updateTaskUI(taskId, isCompleted) {
            const taskCard = document.getElementById(`task-${taskId}`);
            if (!taskCard) return;

            if (isCompleted) {
                taskCard.classList.add('completed');
            } else {
                taskCard.classList.remove('completed');
            }

            const checkbox = taskCard.querySelector('.task-checkbox');
            const title = taskCard.querySelector('.task-title');
            if (checkbox) checkbox.checked = isCompleted;
            if (title) {
                if (isCompleted) {
                    title.style.textDecoration = 'line-through';
                    title.style.color = '#6c757d';
                } else {
                    title.style.textDecoration = 'none';
                    title.style.color = '#2c3e50';
                }
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;

            try {
                const token = getAntiForgeryToken();
                const headers = token ? { 'RequestVerificationToken': token } : {};
                
                const response = await fetch(`/TodoLists/DeleteTask?taskId=${taskId}`, {
                    method: 'POST',
                    headers: headers
                });

                if (!response.ok) throw new Error('Failed to delete task');

                removeTaskFromUI(taskId);

                if (connection) {
                    await connection.invoke("SendTaskDeleted", currentListId, taskId);
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Failed to delete task. Please try again.');
            }
        }

        function removeTaskFromUI(taskId) {
            const taskCard = document.getElementById(`task-${taskId}`);
            if (taskCard) {
                taskCard.remove();
            }

            const container = document.getElementById('tasksContainer');
            if (container && container.children.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✓</div>
                        <h3>No tasks yet</h3>
                        <p>Add your first task above to get started!</p>
                    </div>
                `;
            }
        }

        async function createList() {
            const name = document.getElementById('listNameInput').value.trim();
            const sharedWith = document.getElementById('sharedWithInput').value.trim();

            if (!name) {
                alert('Please enter a list name');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('Name', name);
                if (sharedWith) {
                    formData.append('SharedWith', sharedWith);
                }
                
                const token = getAntiForgeryToken();
                if (token) {
                    formData.append('__RequestVerificationToken', token);
                }

                const response = await fetch('/TodoLists/Create', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok || response.redirected) {
                    bootstrap.Modal.getInstance(document.getElementById('createListModal')).hide();
                    window.location.reload();
                } else {
                    throw new Error('Failed to create list');
                }
            } catch (error) {
                console.error('Error creating list:', error);
                alert('Failed to create list. Please try again.');
            }
        }

        function editListFromElement(button) {
            const listItem = button.closest('.todo-list-item');
            const id = parseInt(listItem.dataset.listId);
            const name = listItem.dataset.listName;
            const shared = listItem.dataset.listShared || '';
            
            document.getElementById('editListId').value = id;
            document.getElementById('editListNameInput').value = name;
            document.getElementById('editSharedWithInput').value = shared;
            new bootstrap.Modal(document.getElementById('editListModal')).show();
        }

        async function saveList() {
            const id = document.getElementById('editListId').value;
            const name = document.getElementById('editListNameInput').value.trim();
            const sharedWith = document.getElementById('editSharedWithInput').value.trim();

            if (!name) {
                alert('Please enter a list name');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('Id', id);
                formData.append('Name', name);
                formData.append('OwnerEmail', currentUserEmail);
                if (sharedWith) {
                    formData.append('SharedWith', sharedWith);
                }
                
                const token = getAntiForgeryToken();
                if (token) {
                    formData.append('__RequestVerificationToken', token);
                }

                const response = await fetch(`/TodoLists/Edit/${id}`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    throw new Error('Failed to update list');
                }
            } catch (error) {
                console.error('Error updating list:', error);
                alert('Failed to update list. Please try again.');
            }
        }

        async function deleteList(id) {
            if (!confirm('Are you sure you want to delete this list? All tasks will be deleted.')) return;

            try {
                const formData = new FormData();
                formData.append('id', id);
                
                const token = getAntiForgeryToken();
                if (token) {
                    formData.append('__RequestVerificationToken', token);
                }

                const response = await fetch(`/TodoLists/Delete/${id}`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    throw new Error('Failed to delete list');
                }
            } catch (error) {
                console.error('Error deleting list:', error);
                alert('Failed to delete list. Please try again.');
            }
        }

        async function shareList(listId) {
            const email = document.getElementById('shareEmailInput').value.trim();
            if (!email) {
                alert('Please enter an email address');
                return;
            }

            try {
                const list = await (await fetch(`/TodoLists/GetList?id=${listId}`)).json();
                const currentShared = list.sharedWith || '';
                const newShared = currentShared ? `${currentShared},${email}` : email;

                const formData = new FormData();
                formData.append('Id', listId);
                formData.append('Name', list.name);
                formData.append('OwnerEmail', list.ownerEmail);
                formData.append('SharedWith', newShared);
                
                const token = getAntiForgeryToken();
                if (token) {
                    formData.append('__RequestVerificationToken', token);
                }

                const response = await fetch(`/TodoLists/Edit/${listId}`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    document.getElementById('shareEmailInput').value = '';
                    loadList(listId);
                } else {
                    throw new Error('Failed to share list');
                }
            } catch (error) {
                console.error('Error sharing list:', error);
                alert('Failed to share list. Please try again.');
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text ? text.replace(/[&<>"']/g, m => map[m]) : '';
        }

        function getAntiForgeryToken() {
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            return token ? token.value : '';
        }

        function addListToSidebar(listId, listName, ownerEmail, isShared) {
            const listsContainer = document.getElementById('listsContainer');
            
            const existingList = document.querySelector(`[data-list-id="${listId}"]`);
            if (existingList) {
                return;
            }

            const emptyState = listsContainer.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const listItem = document.createElement('div');
            listItem.className = 'todo-list-item';
            listItem.dataset.listId = listId;
            listItem.dataset.listName = listName;
            listItem.dataset.listShared = '';
            listItem.onclick = () => loadList(listId);
            
            const isOwner = ownerEmail === currentUserEmail;
            listItem.innerHTML = `
                <div class="todo-list-item-name">${escapeHtml(listName)}</div>
                <div class="todo-list-item-meta">
                    <span>0 tasks</span>
                    ${isShared ? '<span class="badge bg-info">Shared</span>' : ''}
                </div>
                ${isOwner ? `
                <div class="todo-list-item-actions" onclick="event.stopPropagation()">
                    <button class="btn btn-sm btn-outline-primary" onclick="editListFromElement(this)">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteList(${listId})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                ` : ''}
            `;

            listsContainer.insertBefore(listItem, listsContainer.firstChild);

            showNotification(`New list "${listName}" has been shared with you!`, 'info');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'info' ? 'info' : 'success'} alert-dismissible fade show`;
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            notification.innerHTML = `
                ${escapeHtml(message)}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
}